# Sub-Store 节点重命名脚本 - IP地理位置解析增强版

## 🚀 新增功能

### IP地理位置自动解析
通过联网查询节点真实IP的地理位置，自动识别国家/地区并重命名节点。

---

## 📖 使用方法

### 基础用法

```
https://你的脚本地址/sub-store-原版.js#ipgeo
```

### 组合参数示例

1️⃣ **启用IP解析 + 添加国旗 + 机场前缀**
```
https://你的脚本地址/sub-store-原版.js#ipgeo&flag&name=[我的机场]
```

2️⃣ **启用IP解析 + 英文输出 + 清理序号01**
```
https://你的脚本地址/sub-store-原版.js#ipgeo&out=en&one
```

3️⃣ **启用IP解析 + 保留关键词**
```
https://你的脚本地址/sub-store-原版.js#ipgeo&blkey=IPLC+GPT&flag
```

---

## 🔧 参数说明

### 核心参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `ipgeo` | **启用IP地理位置解析**（支持域名和IP） | `#ipgeo` |
| `flag` | 添加国旗到节点名前缀 | `#flag` |
| `name=` | 添加机场名称前缀 | `#name=[机场]` |
| `out=` | 输出格式：`zh`中文/`en`英文/`flag`国旗/`quan`英文全称 | `#out=en` |
| `one` | 清理只有一个节点的地区的序号01 | `#one` |

### 保留参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `blkey=` | 保留节点名的自定义关键词（用+分隔） | `#blkey=IPLC+GPT+NF` |
| `blgd` | 保留：家宽、IPLC、ˣ² 等标识 | `#blgd` |
| `bl` | 保留倍率标识（0.5x, 2x, 3倍等） | `#bl` |
| `clear` | 清理乱名（套餐、到期、测试等） | `#clear` |

---

## 🌟 工作原理

### 1. 节点格式识别

脚本会自动提取节点配置中的服务器地址：

```javascript
// 支持的字段（优先级从高到低）
- proxy.server
- proxy.hostname  
- proxy.host
```

### 2. 真实IP解析

- **域名自动解析**：`example.com:443` → 查询域名真实IP位置
- **IP直接查询**：`1.2.3.4:8080` → 直接查询IP位置
- **默认端口处理**：域名不带端口时默认443

### 3. 地理位置映射

使用**多API备用方案**查询IP归属地（自动切换）：

**优先级顺序：**
1. **ipapi.co** (国内可访问，支持HTTPS，推荐)
2. **ip-api.com** (需要代理，数据准确)
3. **ipinfo.io** (国内访问较慢但可用)

```
输入: youxuan.cf:443
↓
解析IP: 104.21.45.123
↓
查询地理位置: United States (US)
↓
映射中文名: 美国
↓
输出: 🇺🇸 美国 01
```

### 4. 缓存机制

- 同一IP/域名只查询一次
- 减少API请求次数
- 提升处理速度

---

## 📊 支持的国家/地区

### 常用地区（完整支持）

| 代码 | 中文名 | 英文名 |
|------|--------|--------|
| HK | 香港 | Hong Kong |
| TW | 台湾 | Taiwan |
| JP | 日本 | Japan |
| KR | 韩国 | Korea |
| SG | 新加坡 | Singapore |
| US | 美国 | United States |
| GB | 英国 | United Kingdom |
| DE | 德国 | Germany |
| FR | 法国 | France |
| RU | 俄罗斯 | Russia |
| AU | 澳大利亚 | Australia |
| CA | 加拿大 | Canada |
| TR | 土耳其 | Turkey |
| TH | 泰国 | Thailand |
| AE | 阿联酋 | United Arab Emirates |

*支持全球200+个国家/地区，未列出的会使用英文国家名*

---

## 💡 实际效果对比

### 优化前（无法识别）
```
youxuan.cf.090227.xyz:443
123.cf.090227.xyz:8080
mfa.gov.ua:443
```
❌ 这些节点因为不包含地区关键词被过滤或保持原名

### 优化后（启用 ipgeo）
```
🇺🇸 美国 01  (youxuan.cf -> US)
🇸🇬 新加坡 01 (123.cf -> SG)  
🇺🇦 乌克兰 01 (mfa.gov.ua -> UA)
```
✅ 自动识别真实IP地理位置并重命名

---

## ⚠️ 注意事项

### 1. 网络访问（重要！）

#### 国内网络使用
- ✅ **首选API：ipapi.co** - 国内直连可用
- ⚠️ **可能较慢** - 因为服务器在国外，DNS解析需要时间
- ✅ **备用方案** - 如果第一个API失败，自动尝试下一个

#### 国外网络使用
- ✅ **所有API均可用** - 速度更快
- ✅ **推荐开启代理** - Sub-Store订阅更新时开启代理

#### 如果提示"无网络"
```bash
# 原因分析
1. Sub-Store运行环境未开启代理
2. DNS解析被污染（ip-api.com在国内被封）
3. API响应超时

# 解决方法
✅ 方法1: 在Sub-Store设置中开启代理（推荐）
✅ 方法2: 等待ipapi.co响应（可能需要2-5秒/节点）
✅ 方法3: 使用国外网络环境更新订阅
```

### 2. API限制
### 2. API限制
- **ipapi.co**: 1000次/天（免费）
- **ip-api.com**: 45次/分钟（免费）
- **ipinfo.io**: 50000次/月（免费）
- 建议节点数量较多时分批处理
- 超过限制会自动跳过，保留原节点名

### 3. 联网要求
### 3. 联网要求
- **国内网络**：可以使用，但建议开启代理
- **国外网络**：所有API均可正常访问
- Sub-Store 运行环境需要支持 `$http.get` 方法
- 查询过程需要几秒钟时间（串行处理，更稳定）

### 4. 性能影响
- 首次运行较慢（需要逐个查询节点）
- 163个节点大约需要2-5分钟（国内网络）
- 缓存后速度显著提升
- 建议配合 `noCache` 参数控制

### 5. 兼容性
- 保持向后兼容，不影响原有功能
- 不启用 `ipgeo` 参数时工作方式完全不变

---

## 🔥 推荐配置

### 场景1: 机场订阅优化
```
#ipgeo&flag&name=[我的机场]&one&clear
```
- 解析IP位置
- 添加国旗
- 添加机场前缀
- 清理单节点地区的01
- 清理垃圾命名

### 场景2: 极简模式
```
#ipgeo&flag&out=en&one
```
- 解析IP位置
- 添加国旗
- 英文简写输出
- 清理序号01

### 场景3: 专线保留
```
#ipgeo&blkey=IPLC+IEPL&blgd&flag
```
- 解析IP位置
- 保留IPLC/IEPL关键词
- 保留家宽等标识
- 添加国旗

---

## 🐛 故障排查

### 问题1: 节点还是被过滤
**原因**: API查询失败或限流  
**解决**: 
- 检查网络连接（建议开启代理）
- 查看Sub-Store控制台日志
- 尝试使用国外网络

### 问题2: 提示"无网络"
**原因**: 国内网络无法访问ip-api.com  
**解决**: 
- ✅ **方法1**：在Sub-Store设置中开启代理
- ✅ **方法2**：等待ipapi.co自动生效（慢但可用）
- ✅ **方法3**：切换到国外网络环境

### 问题3: 地理位置不准确
**原因**: CDN节点或Anycast IP  
**解决**: 
- 这是正常现象，显示的是IP注册地
- 可以手动使用 `in=` 参数强制指定

### 问题4: 速度太慢
**原因**: 大量节点需要逐个查询  
**解决**: 
- 第二次运行会快很多（有缓存）
- 国外网络环境会更快
- 建议配合节点过滤使用

### 问题5: 控制台日志查看
**Sub-Store控制台日志示例**：
```
[IPGeo] 开始解析节点IP地理位置...
[IPGeo] 提示: 国内网络建议使用代理，或等待ipapi.co响应
[IPGeo] 尝试 ipapi.co: youxuan.cf
[IPGeo] ✓ ipapi.co 成功: youxuan.cf -> US
[IPGeo] 尝试 ipapi.co: 123.cf
[IPGeo] ✓ ipapi.co 成功: 123.cf -> SG
[IPGeo] 解析完成!
```

---

## 📝 更新日志

### v1.2 (2024-10-16)
- ✅ 新增多API备用方案（ipapi.co优先，国内可用）
- ✅ 修复国内网络"无网络"问题
- ✅ 优化为串行处理，避免API限流
- ✅ 改用 `$http.get` 替代 `fetch`，兼容性更好
- ✅ 添加详细控制台日志输出

### v1.1 (2024-10-16)
- ✅ 新增IP地理位置自动解析功能
- ✅ 支持域名和IP地址查询
- ✅ 添加查询缓存机制
- ✅ 优化默认保留未匹配节点
- ✅ 补充20+常用国家代码映射

### v1.0 (2024-04-05)
- 基础重命名功能

---

## 📧 反馈与建议

如有问题或建议，请提交Issue或Pull Request。

---

**祝使用愉快！** 🎉
